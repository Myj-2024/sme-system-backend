<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sme.mapper.SmeNoticeMapper">

    <resultMap id="SmeNoticeResultMap" type="com.sme.entity.SmeNotice">
        <id column="id" property="id" />
        <result column="title" property="title" />
        <result column="notice_type" property="noticeType" />
        <result column="publisher_id" property="publisherId" />
        <result column="content" property="content" />
        <result column="publish_time" property="publishTime" />
        <result column="target_type" property="targetType" />
        <result column="target_value" property="targetValue" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
        <result column="del_flag" property="delFlag" />
        <result column="is_read" property="isRead" />
        <result column="publisher_name" property="publisherName"/>
        <!-- 新增：映射发布人部门名称 -->
        <result column="publisher_dept_name" property="publisherDeptName"/>
    </resultMap>

    <!-- 新增通知主体 -->
    <insert id="saveNotice" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO gh_sme_service.sme_notice (
        title, notice_type, publisher_id, content,
        publish_time, target_type, target_value,
        create_time, update_time, del_flag
        ) VALUES (
        #{title}, #{noticeType}, #{publisherId}, #{content},
        #{publishTime},#{targetType},
        <if test="targetType == 'SPECIFIC_USER' and targetUserIds != null and targetUserIds.size() > 0">
            #{targetUserIds,jdbcType=VARCHAR,typeHandler=com.sme.handler.ListToStringTypeHandler},
        </if>
        <if test="targetType != 'SPECIFIC_USER'">
            '',
        </if>
        NOW(), NOW(), 0
        )
    </insert>
    <delete id="deleteById">
        DELETE FROM gh_sme_service.sme_notice
        WHERE id = #{id}
          AND del_flag = 0
    </delete>

    <!-- 分页查询通知 -->
    <select id="pageQuery" resultMap="SmeNoticeResultMap">
        SELECT
        p.id,
        p.title,
        p.notice_type,
        p.publisher_id,
        gy.real_name AS publisher_name,
        -- 新增：关联字典项表获取发布人部门名称
        di.item_name AS publisher_dept_name,
        p.content,
        p.publish_time,
        p.target_type,
        p.target_value,
        p.create_time,
        p.update_time,
        p.del_flag
        FROM gh_sme_service.sme_notice p
        LEFT JOIN gh_sme_service.sys_user gy
        ON p.publisher_id = gy.id AND gy.del_flag = 0
        -- 新增：关联字典项表（dict_id=10 是部门字典）
        LEFT JOIN gh_sme_service.sys_dict_item di
        ON gy.dept_code = di.item_code AND di.dict_id = 10 AND di.del_flag = 0 AND di.status = 1
        WHERE p.del_flag = 0
        <if test="title != null and title != ''">
            AND p.title LIKE CONCAT('%', #{title}, '%')
        </if>
        <if test="noticeType != null and noticeType != ''">
            AND p.notice_type = #{noticeType}
        </if>
        <if test="publisherId != null">
            AND p.publisher_id = #{publisherId}
        </if>
        <if test="publisherName != null and publisherName != ''">
            AND gy.real_name LIKE CONCAT('%', #{publisherName}, '%')
        </if>
        ORDER BY p.publish_time
    </select>

    <!-- 根据ID查询通知详情 -->
    <select id="getById" resultMap="SmeNoticeResultMap">
        SELECT n.id, n.title, n.notice_type, n.publisher_id, n.content,
               n.publish_time, n.target_type, n.target_value,
               n.create_time, n.update_time,
               n.del_flag,
               u.real_name AS publisher_name,
               -- 新增：关联字典项表获取发布人部门名称
               di.item_name AS publisher_dept_name
        FROM gh_sme_service.sme_notice n
                 LEFT JOIN gh_sme_service.sys_user u ON n.publisher_id = u.id AND u.del_flag = 0
            -- 新增：关联字典项表（部门字典）
                 LEFT JOIN gh_sme_service.sys_dict_item di ON u.dept_code = di.item_code AND di.dict_id = 10 AND di.del_flag = 0 AND di.status = 1
        WHERE n.id = #{id}
          AND n.del_flag = 0
    </select>

    <!-- 修改通知 -->
    <update id="updateNotice">
        UPDATE gh_sme_service.sme_notice
        <set>
            title = #{title},
            notice_type = #{noticeType},
            content = #{content},
            publish_time = #{publishTime},
            target_type = #{targetType},
            target_value =
            <if test="targetType == 'SPECIFIC_USER' and targetUserIds != null and targetUserIds.size() > 0">
                #{targetUserIds,jdbcType=VARCHAR,typeHandler=com.sme.handler.ListToStringTypeHandler},
            </if>
            <if test="targetType != 'SPECIFIC_USER'">
                '',
            </if>
            update_time = NOW()
        </set>
        WHERE id = #{id}
        AND del_flag = 0
    </update>

    <!-- 查询当前用户收到的通知列表 -->
    <select id="queryMyNotice" resultMap="SmeNoticeResultMap">
        SELECT p.id, p.title, p.notice_type, p.publisher_id,
               gy.real_name AS publisher_name,
               di.item_name AS publisher_dept_name,
               p.content,
               p.publish_time, p.target_type, p.target_value,
               p.create_time, p.update_time,
               p.del_flag,
               nu.is_read
        FROM gh_sme_service.sme_notice p
                 LEFT JOIN gh_sme_service.sme_notice_user nu ON p.id = nu.notice_id AND nu.user_id = #{userId}
                 LEFT JOIN gh_sme_service.sys_user gy ON p.publisher_id = gy.id AND gy.del_flag = 0
                 LEFT JOIN gh_sme_service.sys_dict_item di ON gy.dept_code = di.item_code AND di.dict_id = 10 AND di.del_flag = 0 AND di.status = 1
        WHERE p.del_flag = 0
          AND nu.id IS NOT NULL
        ORDER BY
            -- 核心逻辑：未读(0)在前，已读(1)在后
            nu.is_read ASC,
            -- 次要逻辑：时间倒序，最新的在前面
            p.publish_time DESC
    </select>

    <!-- 修正：查询当前用户发送的通知列表（适配实际表结构） -->
    <select id="querySentNotice" resultMap="SmeNoticeResultMap">
        SELECT
        p.id,
        p.title,
        p.notice_type,
        p.publisher_id,
        gy.real_name AS publisher_name,  <!-- 关联发布人姓名 -->
        -- 新增：关联字典项表获取发布人部门名称
        di.item_name AS publisher_dept_name,
        p.content,
        p.publish_time,
        p.target_type,
        p.target_value,
        p.create_time,
        p.update_time,
        p.del_flag
        FROM gh_sme_service.sme_notice p
        <!-- 关联用户表获取发布人姓名 -->
        LEFT JOIN gh_sme_service.sys_user gy ON p.publisher_id = gy.id AND gy.del_flag = 0
        -- 新增：关联字典项表（部门字典）
        LEFT JOIN gh_sme_service.sys_dict_item di ON gy.dept_code = di.item_code AND di.dict_id = 10 AND di.del_flag = 0 AND di.status = 1
        WHERE
        p.del_flag = 0  <!-- 修正：使用正确的逻辑删除字段del_flag -->
        AND p.publisher_id = #{publisherId}  <!-- 核心条件：发布人ID = 当前用户ID -->
        <!-- 标题模糊查询（可选） -->
        <if test="title != null and title != ''">
            AND p.title LIKE CONCAT('%', #{title}, '%')
        </if>
        ORDER BY
        p.publish_time DESC,  <!-- 按发布时间倒序（和现有逻辑一致） -->
        p.create_time DESC
    </select>
</mapper>