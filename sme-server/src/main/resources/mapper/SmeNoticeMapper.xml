<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sme.mapper.SmeNoticeMapper">

    <resultMap id="SmeNoticeResultMap" type="com.sme.entity.SmeNotice">
        <id column="id" property="id" />
        <result column="title" property="title" />
        <result column="notice_type" property="noticeType" />
        <result column="publisher_id" property="publisherId" />
        <result column="content" property="content" />
        <result column="publish_time" property="publishTime" />
        <result column="target_type" property="targetType" />
        <result column="target_value" property="targetValue" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
        <!-- 若sme_notice表无del_flag字段，删除此行 -->
        <result column="del_flag" property="delFlag" />
        <!-- 新增：映射is_read字段 -->
        <result column="is_read" property="isRead" />
        <!-- 发布人姓名映射（与SQL中别名保持一致） -->
        <result property="publisherName" column="publisher_name"/>
    </resultMap>

    <!-- 新增通知主体 -->
    <insert id="saveNotice" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO gh_sme_service.sme_notice (
        title, notice_type, publisher_id, content,
        publish_time, target_type, target_value,
        create_time, update_time
        <!-- 若sme_notice表无del_flag字段，删除此行 -->
        , del_flag
        ) VALUES (
        #{title}, #{noticeType}, #{publisherId}, #{content},
        #{publishTime},#{targetType},
        <if test="targetType == 'SPECIFIC_USER' and targetUserIds != null and targetUserIds.size() > 0">
            #{targetUserIds,jdbcType=VARCHAR,typeHandler=com.sme.handler.ListToStringTypeHandler},
        </if>
        <if test="targetType != 'SPECIFIC_USER'">
            '',
        </if>
        NOW(), NOW()
        <!-- 若sme_notice表无del_flag字段，删除此行 -->
        , 0
        )
    </insert>

    <!-- 分页查询通知（修正publisherName查询逻辑） -->
    <select id="pageQuery" resultMap="SmeNoticeResultMap">
        SELECT
        p.id,
        p.title,
        p.notice_type,
        p.publisher_id,
        gy.real_name AS publisher_name,   <!-- 正确：用real_name -->
        p.content,
        p.publish_time,
        p.target_type,
        p.target_value,
        p.create_time,
        p.update_time,
        p.del_flag
        FROM gh_sme_service.sme_notice p
        LEFT JOIN gh_sme_service.sys_user gy
        ON p.publisher_id = gy.id AND gy.del_flag = 0
        WHERE p.del_flag = 0
        <if test="title != null and title != ''">
            AND p.title LIKE CONCAT('%', #{title}, '%')
        </if>
        <if test="noticeType != null and noticeType != ''">
            AND p.notice_type = #{noticeType}
        </if>
        <!-- 修正：publisherId查询应该用p.publisher_id，不是p.publisher_name -->
        <if test="publisherId != null">
            AND p.publisher_id = #{publisherId}
        </if>
        <if test="publisherName != null and publisherName != ''">
            AND gy.real_name LIKE CONCAT('%', #{publisherName}, '%')
        </if>
        ORDER BY p.publish_time DESC
    </select>

    <!-- 根据ID查询通知详情（修正：用real_name替换user_name） -->
    <select id="getById" resultMap="SmeNoticeResultMap">
        SELECT n.id, n.title, n.notice_type, n.publisher_id, n.content,
        n.publish_time, n.target_type, n.target_value,
        n.create_time, n.update_time,
        <!-- 若sme_notice表无del_flag字段，删除此行 -->
        n.del_flag,
        <!-- 修正：用real_name，别名保持publisher_name -->
        u.real_name AS publisher_name
        FROM gh_sme_service.sme_notice n
        <!-- 左连接用户表，根据 publisher_id 关联 -->
        LEFT JOIN gh_sme_service.sys_user u ON n.publisher_id = u.id AND u.del_flag = 0
        WHERE n.id = #{id}
        <!-- 若sme_notice表无del_flag字段，删除此行 -->
        AND n.del_flag = 0
    </select>

    <!-- 修改通知 -->
    <update id="updateNotice">
        UPDATE gh_sme_service.sme_notice
        <set>
            title = #{title},
            notice_type = #{noticeType},
            content = #{content},
            publish_time = #{publishTime},
            target_type = #{targetType},
            target_value =
            <if test="targetType == 'SPECIFIC_USER' and targetUserIds != null and targetUserIds.size() > 0">
                #{targetUserIds,jdbcType=VARCHAR,typeHandler=com.sme.handler.ListToStringTypeHandler},
            </if>
            <if test="targetType != 'SPECIFIC_USER'">
                '',
            </if>
            update_time = NOW()
        </set>
        WHERE id = #{id}
        <!-- 若sme_notice表无del_flag字段，删除此行 -->
        AND del_flag = 0
    </update>

    <!-- 逻辑删除通知（若sme_notice表无del_flag字段，改为DELETE物理删除） -->
    <update id="deleteById">
        UPDATE gh_sme_service.sme_notice
        SET del_flag = 1, update_time = NOW()
        WHERE id = #{id} AND del_flag = 0
    </update>

    <!-- 查询当前用户的通知列表（补充发布人姓名关联） -->
    <select id="queryMyNotice" resultMap="SmeNoticeResultMap">
        SELECT p.id, p.title, p.notice_type, p.publisher_id,
        gy.real_name AS publisher_name,  <!-- 新增：关联发布人姓名 -->
        p.content,
        p.publish_time, p.target_type, p.target_value,
        p.create_time, p.update_time
        <!-- 若sme_notice表无del_flag字段，删除此行 -->
        , p.del_flag
        , nu.is_read
        FROM gh_sme_service.sme_notice p
        LEFT JOIN gh_sme_service.sme_notice_user nu ON p.id = nu.notice_id AND nu.user_id = #{userId}
        <!-- 新增：关联用户表获取发布人姓名 -->
        LEFT JOIN gh_sme_service.sys_user gy ON p.publisher_id = gy.id AND gy.del_flag = 0
        WHERE p.del_flag = 0 <!-- 若sme_notice表无del_flag字段，删除此行 -->
        AND nu.id IS NOT NULL <!-- 确保关联到用户的通知 -->
        ORDER BY p.publish_time DESC
    </select>
</mapper>