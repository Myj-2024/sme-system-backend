<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sme.mapper.SmePleMapper">

    <!-- ==================== ResultMap ==================== -->
    <resultMap id="SmePleResultMap" type="com.sme.entity.SmePLE">

        <id column="id" property="id"/>

        <result column="leader_name" property="leaderName"/>
        <result column="enterprise_id" property="enterpriseId"/>
        <result column="dept_id" property="classDeptId"/>

        <!-- 企业信息 -->
        <result column="enterprise_name" property="enterpriseName"/>
        <result column="legal_person" property="enterpriseLeader"/>
        <result column="enterprise_phone" property="enterprisePhone"/>
        <result column="business_addr" property="regAddr"/>
        <result column="main_product" property="mainProduct"/>

        <!-- 部门信息 -->
        <result column="dept_name" property="classDeptName"/>
        <result column="dept_leader" property="classMonitor"/>
        <result column="dept_phone" property="classPhone"/>

        <!-- 通用字段 -->
        <result column="remark" property="remark"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="del_flag" property="delFlag"/>

    </resultMap>

    <!-- ==================== 新增 ==================== -->
    <insert id="insert"
            parameterType="com.sme.entity.SmePLE"
            useGeneratedKeys="true"
            keyProperty="id">

        INSERT INTO gh_sme_service.sme_lpe
        (
            leader_name,
            enterprise_id,
            dept_id,
            remark,
            create_time,
            update_time,
            del_flag
        )
        VALUES
            (
                #{leaderName},
                #{enterpriseId},
                #{classDeptId},
                #{remark},
                NOW(),
                NOW(),
                0
            )

    </insert>


    <!-- ==================== 修改 ==================== -->
    <update id="update" parameterType="com.sme.entity.SmePLE">

        UPDATE gh_sme_service.sme_lpe
        SET
            leader_name = #{leaderName},
            enterprise_id = #{enterpriseId},
            dept_id = #{classDeptId},
            remark = #{remark},
            update_time = NOW()
        WHERE id = #{id}
          AND del_flag = 0

    </update>


    <!-- ==================== 删除 ==================== -->
    <delete id="deleteById">
        DELETE FROM gh_sme_service.sme_lpe
        WHERE id = #{id}
    </delete>


    <!-- ==================== 分页查询 ==================== -->
    <select id="page" resultMap="SmePleResultMap">

        SELECT
        l.id,
        l.leader_name,
        l.enterprise_id,
        l.dept_id,

        -- 企业信息
        e.enterprise_name,
        e.legal_person,
        e.phone AS enterprise_phone,
        e.business_addr,
        e.main_product,

        -- 部门信息
        d.dept_name,
        d.leader AS dept_leader,
        d.phone  AS dept_phone,

        -- 通用字段
        l.remark,
        l.create_time,
        l.update_time,
        l.del_flag

        FROM gh_sme_service.sme_lpe l

        LEFT JOIN gh_sme_service.sme_enterprise e
        ON l.enterprise_id = e.id
        AND e.del_flag = 0

        LEFT JOIN gh_sme_service.sys_dept d
        ON l.dept_id = d.id
        AND d.del_flag = 0
        AND d.status = 1

        WHERE l.del_flag = 0

        <if test="leaderName != null and leaderName != ''">
            AND l.leader_name LIKE CONCAT('%', #{leaderName}, '%')
        </if>

        <if test="enterpriseName != null and enterpriseName != ''">
            AND e.enterprise_name LIKE CONCAT('%', #{enterpriseName}, '%')
        </if>

        <if test="classDeptName != null and classDeptName != ''">
            AND d.dept_name LIKE CONCAT('%', #{classDeptName}, '%')
        </if>

        <if test="classMonitor != null and classMonitor != ''">
            AND d.leader LIKE CONCAT('%', #{classMonitor}, '%')
        </if>

        ORDER BY l.create_time DESC

    </select>


    <!-- ==================== 根据ID查询 ==================== -->
    <select id="getPleById" resultMap="SmePleResultMap">

        SELECT
            l.id,
            l.leader_name,
            l.enterprise_id,
            l.dept_id,

            -- 企业信息
            e.enterprise_name,
            e.legal_person,
            e.phone AS enterprise_phone,
            e.business_addr,
            e.main_product,

            -- 部门信息
            d.dept_name,
            d.leader AS dept_leader,
            d.phone  AS dept_phone,

            -- 通用字段
            l.remark,
            l.create_time,
            l.update_time,
            l.del_flag

        FROM gh_sme_service.sme_lpe l

                 LEFT JOIN gh_sme_service.sme_enterprise e
                           ON l.enterprise_id = e.id
                               AND e.del_flag = 0

                 LEFT JOIN gh_sme_service.sys_dept d
                           ON l.dept_id = d.id
                               AND d.del_flag = 0
                               AND d.status = 1

        WHERE l.del_flag = 0
          AND l.id = #{id}

    </select>


    <!-- ==================== 企业统计 ==================== -->
    <select id="countByEnterpriseId"
            parameterType="java.lang.Long"
            resultType="java.lang.Integer">

        SELECT COUNT(1)
        FROM gh_sme_service.sme_lpe
        WHERE del_flag = 0
          AND enterprise_id = #{enterpriseId}

    </select>


    <!-- ==================== 部门统计（改为dept_id） ==================== -->
    <select id="countByDeptId"
            parameterType="java.lang.Long"
            resultType="java.lang.Integer">

        SELECT COUNT(1)
        FROM gh_sme_service.sme_lpe
        WHERE del_flag = 0
          AND dept_id = #{deptId}

    </select>

</mapper>
