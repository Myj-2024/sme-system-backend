<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sme.mapper.PermissionMapper">

    <!-- 基础结果映射（补充isRoute字段） -->
    <resultMap id="BasePermissionResultMap" type="com.sme.entity.SysPermission">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="code" property="code"/>
        <result column="type" property="type"/>
        <result column="path" property="path"/>
        <result column="icon_id" property="iconId"/>
        <result column="parent_id" property="parentId"/>
        <result column="sort" property="sort"/>
        <result column="icon_code" property="iconCode"/>
        <result column="icon_url" property="iconUrl"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="del_flag" property="delFlag"/>
        <result column="isRoute" property="isRoute"/> <!-- 新增：映射isRoute字段 -->
    </resultMap>

    <!-- 关联图标表的结果映射（继承BasePermissionResultMap，自动包含isRoute） -->
    <resultMap id="PermissionResultMap" type="com.sme.entity.SysPermission" extends="BasePermissionResultMap">
        <result column="icon_url" property="iconUrl"/>
    </resultMap>

    <!-- 分页查询（不变） -->
    <select id="getPermissions" resultMap="PermissionResultMap">
        SELECT p.*, i.icon_url
        FROM sys_permission p
        LEFT JOIN sys_icon i ON p.icon_id = i.id AND i.del_flag = 0
        WHERE p.del_flag = 0
        <if test="name != null and name != ''">
            AND p.name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="code != null and code != ''">
            AND p.code LIKE CONCAT('%', #{code}, '%')
        </if>
        ORDER BY p.parent_id ASC, p.sort ASC
    </select>

    <!-- 根据id查询（不变） -->
    <select id="getPermissionById" resultMap="PermissionResultMap">
        SELECT p.*, i.icon_url
        FROM sys_permission p
                 LEFT JOIN sys_icon i ON p.icon_id = i.id AND i.del_flag = 0
        WHERE p.id = #{id}
          AND p.del_flag = 0
    </select>

    <!-- 新增：补充isRoute字段 -->
    <insert id="addPermission">
        INSERT INTO sys_permission (name, code, type, path, icon_id, parent_id, sort, create_time, del_flag, isRoute)
        VALUES (#{name}, #{code}, #{type}, #{path}, #{iconId}, #{parentId}, #{sort}, CURRENT_TIMESTAMP, 0, #{isRoute})
    </insert>

    <!-- 更新：补充isRoute字段 -->
    <update id="updatePermission">
        UPDATE sys_permission
        SET name        = #{name},
        code        = #{code},
        type        = #{type},
        path        = #{path},
        icon_id     = #{iconId},
        parent_id   = #{parentId},
        sort        = #{sort},
        isRoute     = #{isRoute}, <!-- 新增：更新isRoute -->
        update_time = CURRENT_TIMESTAMP
        WHERE id = #{id}
        AND del_flag = 0
    </update>

    <!-- 删除（不变） -->
    <update id="deletePermission">
        UPDATE sys_permission
        SET del_flag    = 1,
            update_time = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <!-- 路径唯一性校验（不变） -->
    <select id="checkPathUnique" resultType="int">
        SELECT COUNT(1)
        FROM sys_permission
        WHERE path = #{path} AND del_flag = 0
        <if test="id != null">
            AND id != #{id}
        </if>
    </select>

    <!-- 查询所有权限（不变） -->
    <select id="selectAllPermissions" resultMap="PermissionResultMap">
        SELECT p.*, i.icon_url
        FROM sys_permission p
                 LEFT JOIN sys_icon i ON p.icon_id = i.id AND i.del_flag = 0
        WHERE p.del_flag = 0
        ORDER BY p.parent_id ASC, p.sort ASC
    </select>

    <!-- 根据角色ID查询菜单（补充isRoute字段查询） -->
    <select id="selectMenuByRoleId" resultMap="BasePermissionResultMap">
        SELECT p.*,
        i.icon_code,
        i.icon_url,
        p.isRoute <!-- 新增：查询isRoute字段 -->
        FROM sys_permission p
        INNER JOIN role_permission rp ON p.id = rp.permission_id
        LEFT JOIN sys_icon i ON p.icon_id = i.id
        WHERE rp.role_id = #{roleId}
        AND p.type = 1
        AND p.del_flag = 0
        AND (i.del_flag = 0 OR i.del_flag IS NULL)
        ORDER BY p.parent_id ASC, p.sort ASC
    </select>

</mapper>