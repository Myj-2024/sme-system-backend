<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sme.mapper.PolicyMapper">

    <!-- 政策表结果映射（关联字典项/用户表扩展字段） -->
    <resultMap id="PolicyResultMap" type="com.sme.entity.Policy">
        <id column="id" property="id" />
        <result column="title" property="title" />
        <result column="policy_type" property="policyType" />
        <result column="publisher_id" property="publisherId" />
        <result column="content" property="content" />
        <result column="publish_time" property="publishTime" />
        <result column="is_top" property="isTop" />
        <result column="is_show" property="isShow" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
        <result column="del_flag" property="delFlag" />
        <result column="policy_type_name" property="policyTypeName" />
        <result column="publisher_name" property="publisherName" />
        <!-- 核心新增：映射发布人所属部门名称 -->
        <result column="publisher_dept_name" property="publisherDeptName" />
    </resultMap>

    <!-- 新增政策 -->
    <insert id="insert" parameterType="com.sme.entity.Policy" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO gh_sme_service.sme_policy(title,policy_type,publisher_id,is_show,content,publish_time,is_top,create_time, update_time)
        VALUES (#{title},#{policyType},#{publisherId},#{isShow},#{content},#{publishTime},#{isTop}, NOW(),NOW())
    </insert>

    <!--修改政策-->
    <update id="updatePolicy">
        update sme_policy
        <set>
            <if test="title != null">title = #{title},</if>
            <if test="policyType != null">policy_type = #{policyType},</if>
            <if test="publisherId != null">publisher_id = #{publisherId},</if>
            <if test="content != null">content = #{content},</if>
            <if test="publishTime != null">publish_time = #{publishTime},</if>
            <if test="isTop != null">is_top = #{isTop},</if>
            <if test="isShow != null">
                is_show = #{isShow},
                <if test="isShow == 0">del_flag = 1,</if>
            </if>
        </set>
        where id = #{id}
    </update>

    <!-- 删除政策 -->
    <delete id="deletePolicy">
        delete from gh_sme_service.sme_policy where id = #{id}
    </delete>

    <!-- PageHelper 分页查询（无需手动分页，插件自动拼接 LIMIT） -->
    <select id="pageQuery" parameterType="com.sme.dto.PolicyPageQueryDTO" resultMap="PolicyResultMap">
        SELECT
        p.id,
        p.title,
        p.policy_type,
        p.publisher_id,
        p.content,
        p.publish_time,
        p.is_top,
        p.is_show,
        p.create_time,
        p.update_time,
        p.del_flag,
        di.item_name as policy_type_name,
        u.real_name as publisher_name,
        <!-- 核心新增：查询发布人所属部门名称 -->
        dept.item_name as publisher_dept_name
        FROM gh_sme_service.sme_policy p
        LEFT JOIN gh_sme_service.sys_dict_item di
        ON p.policy_type = di.item_code
        AND di.dict_id = (SELECT id FROM gh_sme_service.sys_dict WHERE dict_code = 'policy_type' AND del_flag = 0)
        AND di.del_flag = 0
        AND di.status = 1
        LEFT JOIN gh_sme_service.sys_user u
        ON p.publisher_id = u.id
        AND u.del_flag = 0
        AND u.status = 1
        <!-- 核心修改：和通知Mapper一致，直接用dict_id=10，删除子查询 -->
        LEFT JOIN gh_sme_service.sys_dict_item dept
        ON u.dept_code = dept.item_code
        AND dept.dict_id = 10
        AND dept.del_flag = 0
        AND dept.status = 1
        WHERE 1=1  <!-- 替换原有的p.del_flag=0 -->
        <!-- 新增动态条件：默认过滤已隐藏，传showHidden=true则显示所有 -->
        <if test="showHidden != null and showHidden == false">
            AND p.del_flag = 0
        </if>
        <!-- 原有动态筛选条件不变 -->
        <if test="title != null and title != ''">
            AND p.title LIKE CONCAT('%', #{title}, '%')
        </if>
        <if test="policyType != null and policyType != ''">
            AND p.policy_type = #{policyType}
        </if>
        <if test="publisherName != null and publisherName != ''">
            AND u.real_name LIKE CONCAT('%', #{publisherName}, '%')
        </if>
        <if test="content != null and content != ''">
            AND p.content LIKE CONCAT('%', #{content}, '%')
        </if>
        <if test="policyTypeName != null and policyTypeName != ''">
            AND di.item_name LIKE CONCAT('%', #{policyTypeName}, '%')
        </if>
        ORDER BY p.is_top DESC, p.publish_time DESC
    </select>

    <!-- 根据id查询政策 -->
    <select id="getPolicyById" resultMap="PolicyResultMap">
        select
        p.*,
        di.item_name as policy_type_name,
        u.real_name as publisher_name,
        <!-- 核心新增：单条查询也补充部门名称 -->
        dept.item_name as publisher_dept_name
        from gh_sme_service.sme_policy p
        LEFT JOIN gh_sme_service.sys_dict_item di
        ON p.policy_type = di.item_code
        AND di.dict_id = (SELECT id FROM gh_sme_service.sys_dict WHERE dict_code = 'policy_type' AND del_flag = 0)
        AND di.del_flag = 0
        AND di.status = 1
        LEFT JOIN gh_sme_service.sys_user u
        ON p.publisher_id = u.id
        AND u.del_flag = 0
        AND u.status = 1
        <!-- 核心修改：和通知Mapper一致，直接用dict_id=10 -->
        LEFT JOIN gh_sme_service.sys_dict_item dept
        ON u.dept_code = dept.item_code
        AND dept.dict_id = 10
        AND dept.del_flag = 0
        AND dept.status = 1
        where p.id = #{id}
    </select>

    <!-- 修正批量显示的参数名：collection="list" 匹配List<Long>入参 -->
    <update id="batchShowPolicies">
        update gh_sme_service.sme_policy  <!-- 补充库名，和其他SQL保持一致 -->
        set is_show = 1,
        del_flag = 0  <!-- 显示时恢复逻辑未删除状态 -->
        where id in
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 新增：查询所有已隐藏政策ID（del_flag=1 且 is_show=0） -->
    <select id="selectHiddenPolicyIds" resultType="java.lang.Long">
        SELECT id FROM gh_sme_service.sme_policy
        WHERE del_flag = 1 AND is_show = 0
    </select>

</mapper>